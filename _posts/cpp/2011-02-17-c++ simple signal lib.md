---
categories: cpp
---
<div>//typedef function0 &lt;int&gt; FunctionType;<br />#include &lt;iostream&gt;<br />#include &lt;boost/shared_ptr.hpp&gt;<br />#include &lt;vector&gt;<br />#include &lt;algorithm&gt;<br /><br />using namespace boost;<br />using namespace std;<br /><br />typedef int RType;<br />typedef RType (*FunctionType)();<br /><br />class MySlot<br />{<br />public:<br />&nbsp;&nbsp; &nbsp;bool IsValid() {return fun_!=0;}<br />&nbsp;&nbsp; &nbsp;//bool operator == (MySlot const &amp;rls) {return this==&amp;rls;}<br />//protected:<br />//private:<br />&nbsp;&nbsp; &nbsp;//friend class MyConnection;<br />&nbsp;&nbsp; &nbsp;FunctionType&nbsp;&nbsp; &nbsp;fun_;<br />};<br /><br />class MySignal0;<br /><br />class MyConnection<br />{<br />public:<br />&nbsp;&nbsp; &nbsp;bool&nbsp;&nbsp; &nbsp;IsValid() {return slot_ &amp;&amp; slot_-&gt;IsValid();}<br />&nbsp;&nbsp; &nbsp;void &nbsp;&nbsp; &nbsp;Disconnect();<br />&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;bool operator == (MyConnection const &amp;rls) {return signal_ == rls.signal_ &amp;&amp; rls.slot_ == slot_;}<br />&nbsp;&nbsp; &nbsp;<br />//protected:<br />//private:<br />&nbsp;&nbsp; &nbsp;//friend class MySignal0;<br />&nbsp;&nbsp; &nbsp;shared_ptr&lt;MySlot&gt;&nbsp;&nbsp; &nbsp;slot_;&nbsp;&nbsp; &nbsp;//for see connection's state<br />&nbsp;&nbsp; &nbsp;MySignal0*&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;signal_;//for disconnect<br />};<br /><br />&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;<br />class MySignal0<br />{<br />public:<br />&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;//MyConnection Connect(const FunctionType &amp; fun)&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;MyConnection Connect(FunctionType fun)&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;MyConnection con;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;con.slot_.reset(new MySlot);<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;con.slot_-&gt;fun_ = fun;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;con.signal_ = this;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cons_.push_back(con);<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return con;<br />&nbsp;&nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;RType operator()()<br />&nbsp;&nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;vector &lt;MyConnection&gt;::iterator it = cons_.begin();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;vector &lt;MyConnection&gt;::iterator itEnd = cons_.end();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;RType r = RType();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;for(;it!=itEnd;++it)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if((*it).slot_)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;r = (*it).slot_-&gt;fun_();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;return r;<br />&nbsp;&nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp;<br />//protected:<br />//private:<br />&nbsp;&nbsp; &nbsp;void Remove(MyConnection const &amp;con)<br />&nbsp;&nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;vector &lt;MyConnection&gt;::iterator it = std::find(cons_.begin(),cons_.end(),con);<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;if(it!=cons_.end())<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;(*it).slot_.reset();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;std::remove(cons_.begin(),cons_.end(),con);<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cout&lt;&lt;"Remove Succeed.\n";<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;else<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cout&lt;&lt;"Remove Fail.\n";<br />&nbsp;&nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;vector &lt;MyConnection&gt;&nbsp; cons_;<br />&nbsp;&nbsp; &nbsp;<br />};<br /><br />void &nbsp;&nbsp; &nbsp;MyConnection::Disconnect(){&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;signal_-&gt;Remove(*this);<br />}<br /><br />int f() {<br />&nbsp;&nbsp; &nbsp;cout&lt;&lt;"f()\n";<br />&nbsp;&nbsp; &nbsp;return 0;<br />}<br /><br />void main1()<br />{<br />&nbsp;&nbsp; &nbsp;MySignal0 sig;<br />&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;MyConnection con = sig.Connect(f);<br />&nbsp;&nbsp; &nbsp;sig();<br />&nbsp;&nbsp; &nbsp;con.Disconnect();<br />&nbsp;&nbsp; &nbsp;sig();<br />}<br /><br />void main()<br />{<br />&nbsp;&nbsp; &nbsp;MyConnection con;<br />&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;cout&lt;&lt;"after init con:\n";<br />&nbsp;&nbsp; &nbsp;cout&lt;&lt;"con is_valid:"&lt;&lt;con.IsValid()&lt;&lt;endl;<br />&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;{<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;MySignal0 sig;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cout&lt;&lt;"after connect to sig:\n";<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;con = sig.Connect(f);<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;sig();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cout&lt;&lt;"con is_valid:"&lt;&lt;con.IsValid()&lt;&lt;endl;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cout&lt;&lt;"after disconnect:\n";<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;con.Disconnect();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;sig();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cout&lt;&lt;"con is_valid:"&lt;&lt;con.IsValid()&lt;&lt;endl;<br />&nbsp;&nbsp; &nbsp;}<br />&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;cout&lt;&lt;"after signal destruct:\n";<br />&nbsp;&nbsp; &nbsp;cout&lt;&lt;"con is_valid:"&lt;&lt;con.IsValid()&lt;&lt;endl;<br />}<br /></div>