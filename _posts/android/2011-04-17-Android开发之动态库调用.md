<div>发信人: yangAlbert (蓝), 信区: Android<br />标&nbsp; 题: Android开发之动态库调用<br />发信站: 武汉白云黄鹤站 (2011年02月20日23:20:51 星期天)<br /><br /><br />1.编写并生成Android下可用的动态库<br />（1）编写动态库源程序文件<br />&nbsp;&nbsp;&nbsp; 这里以my_add.c为例。首先进入/home/android/development/，该目录下创建文件夹<br />lib_test，更爱该目录的权限后进入该目录。依次执行<br />&nbsp;&nbsp;&nbsp; # cd /home/android/development<br />&nbsp;&nbsp;&nbsp; # mkdir lib_test<br />&nbsp;&nbsp;&nbsp; # chmod 777 ./lib_test<br />&nbsp;&nbsp;&nbsp; # cd ./lib_test<br />&nbsp;&nbsp;&nbsp; 在lib_test下创建my_add.c源文件，如下。<br />/*<br />my_add.c<br />*/<br />#include &lt;stdio.h&gt;<br />int add(int x, int y)<br />{&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;int sum = x + y;<br />&nbsp;&nbsp; &nbsp;printf("The sum of %d and %d is %d\n", x, y, sum);<br />&nbsp;&nbsp; &nbsp;return sum;<br />}<br /><br />该程序计算两个整形变量的和并返回该值，同时打印求和信息。<br /><br />（2）编写Android.mk文件<br />&nbsp;&nbsp;&nbsp; 在lib_test目录下创建Android.mk文件，内容如下<br />LOCAL_PATH:=$(call my-dir)<br /><br />include $(CLEAR_VARS)<br /><br />LOCAL_SRC_FILES:= my_add.c<br /><br />LOCAL_MODULE:=libmy_add<br /><br />LOCAL_PRELINK_MODULE := false<br />include $(BUILD_SHARED_LIBRARY)<br /><br /><br />（3）编译动态库<br />&nbsp;&nbsp;&nbsp; 进入lib_test目录，用mm命令编译动态库。<br />&nbsp;&nbsp;&nbsp; # cd /home/android/development/lib_test<br />&nbsp;&nbsp;&nbsp; # mm<br />&nbsp;&nbsp;&nbsp; 编译完成之后生成的动态库文件明为$(LOCAL_MODULE).so，即libmy_add.so。该动态<br />库位于/home/android/out/target/product/generic/system/lib目录下。<br /><br /><br />2.调用动态库<br />（1）编写调用动态库的源程序<br />&nbsp;&nbsp;&nbsp; 在删除之前在lib_test目录下的创建的my_add.c和Android.mk文件，并在该目录下创<br />建libtest.c文件以及my_add.h文件，内容如下:<br />/*<br />libtest.c<br />*/<br />#include &lt;stdio.h&gt;<br />#include "my_add.h"<br /><br />int main()<br />{<br />&nbsp;&nbsp; &nbsp;add(3,4);<br />&nbsp;&nbsp; &nbsp;printf("Done\n");<br />&nbsp;&nbsp; &nbsp;return 0;<br />}<br /><br />my_add.h头文件:<br />/*<br />my_add.h<br />*/<br />int add(int x, int y);<br /><br />（2）编写Android.mk文件<br />&nbsp;&nbsp;&nbsp; 在lib_test目录下创建Android.mk文件，内容如下。<br />LOCAL_PATH:=$(call my-dir)<br /><br />include $(CLEAR_VARS)<br /><br />LOCAL_SRC_FILES:=libtest.c<br /><br />LOCAL_MODULE:=lib_test<br /><br />LOCAL_SHARED_LIBRARIES:=libmy_add<br /><br />include $(BUILD_EXECUTABLE)<br />注:LOCAL_SHARED_LIBRARIES指明要调用的动态库文件，这里动态库文件为libmy_add.so，<br />位于/home/android/out/target/product/generic/lib目录下，编译时会自动在这个目录<br />下寻找该动态库文件。<br /><br />（3）编译<br />&nbsp;&nbsp;&nbsp; 进入lib_test目录，使用mm命令进行编译。<br />&nbsp;&nbsp;&nbsp; # cd /home/android/development/lib_test<br />&nbsp;&nbsp;&nbsp; # mm<br />&nbsp;&nbsp;&nbsp; 生成的可执行文件lib_test文件位于/home/android/out/target/product/generic/s<br />ystem/bin目录下。<br /><br /><br />3.在Android模拟器中使用<br />（1）启动模拟器<br />（2）运行程序<br />&nbsp;&nbsp;&nbsp; 等待模拟器初始化完成后，将lib_test文件push进模拟器，并将libmy_add.so文件pu<br />sh至模拟器的system/lib目录下。<br />&nbsp;&nbsp;&nbsp; 由于模拟器下/system/目录为制度目录，需修改权限，使用adb remount 命令。依次<br />执行：&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp;&nbsp; #adb remount<br />&nbsp;&nbsp;&nbsp; # adb push /home/android/out/target/product/generic/system/lib/libmy_add.s<br />o /system/lib<br />&nbsp;&nbsp;&nbsp; # adb push /home/android/out/target/product/generic/system/bin/lib_test /d<br />ata<br />执行push命令之后登录模拟器，在模拟器终端下调用lib_test执行。<br />&nbsp;&nbsp;&nbsp; # adb shell<br />&nbsp;&nbsp;&nbsp; #/data/lib_test<br /><br /><br />4.隐藏动态库函数细节<br />&nbsp;&nbsp;&nbsp; 可通过选项-fvisibility=hidden将动态库中不必要暴露的函数和全局变量隐藏起来。<br />从而在调用动态库的时候，只有不被隐藏（开放）的函数可以调用，其他函数和变量这部<br />能被调用（引用）。在Android.mk文件中的LOCAL_CFLAG中加入该选项即可，及<br />&nbsp;&nbsp;&nbsp; LOCAL_CFLAG += -fvisibility=hidden。<br />&nbsp;&nbsp;&nbsp; 而要开放的函数前只需加上__attribute__ ((visibility ("default")))限定。<br />&nbsp;&nbsp;&nbsp; 例如生成通过以下mylib.c生成动态库libmylib.so，可编写Android.mk文件为：<br />#Android.mk file<br />LOCAL_PATH:=$(call my-dir)<br /><br />include $(CLEAR_VARS)<br /><br />LOCAL_SRC_FILES:=\<br />&nbsp;&nbsp; &nbsp;mylib.c<br /><br />LOCAL_MODULE:=libmylib<br /><br />LOCAL_CFLAGS +=-fvisibility=hidden<br /><br />LOCAL_PRELINK_MODULE := false<br /><br />include $(BUILD_SHARED_LIBRARY)<br /><br />/*<br />mylib.c<br />*/<br />#include &lt;stdio.h&gt;<br /><br />__attribute__ ((visibility ("default")))&nbsp; int add(int x, int y)<br />{<br />&nbsp;&nbsp; &nbsp;int sum = x + y;<br />&nbsp;&nbsp; &nbsp;printf("%d add %d is %d\n", x, y, sum);<br />&nbsp;&nbsp; &nbsp;return sum;<br />}<br /><br /><br />int sub(int x, int y)<br />{<br />&nbsp;&nbsp; &nbsp;int sub = x - y;<br /><br />&nbsp;&nbsp; &nbsp;printf("%d sub %d is %d\n", x, y, sub);<br />&nbsp;&nbsp; &nbsp;return sub;<br />}<br /><br />int mul(int x, int y)<br />{<br />&nbsp;&nbsp; &nbsp;int mul = x*y;<br /><br />&nbsp;&nbsp; &nbsp;printf("%d multiply %d is %d\n", x, y, mul);<br /><br />&nbsp;&nbsp; &nbsp;return mul;<br />}<br />&nbsp;&nbsp;&nbsp; 这样通过mm命令编译生成的libmylib.so中只有函数int add(int x, int y)是可以被<br />调用的，而int sub(int x, int y)和int mul(int x, int y)则不能被调用。如过源文件<br />调用动态库中的sub(或mul)函数，编译该文件是会出现无法找到sub函数的错误。<br /><br /><br />pdf版下载地址：<br />http://byhh.net/f/Android/1298215084/Android_lib.pdf <br /><br />Good luck!<br />--<br /></div>