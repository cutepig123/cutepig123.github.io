<div class="post">
	<div class="postTitle">
		<a id="viewpost1_TitleUrl" class="postTitle2" href="http://www.cppblog.com/wlwlxj/archive/2006/12/15/16495.html">用MFC实现WebGUI－－(CDHtmlDialog)</a>
	</div>
自从去年年底一次棘手的界面，开始研究用web做界面到现在大约1年，这一年间不是局限在实现层面，也并非一直研究这一个问题，有很多问题其实不是问题，
只是自己没有想清楚或者思想没放开。对于一个界面开发人员，想必拉的对话框不少于100个，腻味不必说，光是对话框大小改变导致控件跟着变化都需要一番功
夫，加上界面美观，界面的风格统一，界面的灵活多变......，头痛。在对话框里面加载位图，加载gif，超链接......，啊，没法控制了吧！在考
虑远点，现在.net3.0技术已经完全打破应用和桌面的界限，我们的界面html资源完全可以放在一个web站点上，这样界面是完全动态的。<br><br>其
间写过2篇这方面的文章，基于vc6实现，绕弯很大。在vc7.1、vc8里面要简单很多，主要是把几个以前为公开的类公开了，最重要的是在CWnd里面
加入了一个虚函数CreateControlSite使得有机会改变控件站点以修改控件行为。在mfc类层次上，CHTMLView和
CDHtmlDialog为开发者提供了创建webgui的一系列基础设施，包括事件机制、窗口行为、以及对html文档操纵接口。我们在此基础上实现
webgui很简单，然而仍然困惑我很久，经理也催过我几次我一直未肯决定最终方案。在我脑袋里一直琢磨是要应用程序完全操纵html文档，还是html
访问应用获取信息，其实就是它们之间的通信模式。一直到昨天我才定下方案，应用通过IWebBrowser2接口操纵html元素，html通过
vbscript、javascript脚本响应本身事件，访问应用。主要是考虑通信自然畅通，而以前我一味想通过应用指令完全控制html元素，导致去
解析html文档，费力不讨好。下面开始我的想法：<br><br>写一个dll，封装CDHtmlDialog，提供一个类似html容器的对话框，功
能就是加载html网页，以及创建与html呼应的com组件。它本身不包含与应用功能有关代码，应用有关的部分是html页面和对于的com功能组件。
这里需要对CDHtmlDialog进行了适当的改造以适合自己的目标：<br><br>首先从CDHtmlDialog派生一个类CHTMLContainerDlg，默认情况下会生成一个网页资源，这个网页是这个对话框创建时加载的，我们需要的其实是一个容器而不是一个具体的对话框，所以删除网页资源，修改对话框头文件：<br><div style="border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; font-size: 13px; width: 98%; background-color: rgb(238, 238, 238);"><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top"><span style="color: rgb(0, 0, 0);">enum&nbsp;{&nbsp;IDD&nbsp;=&nbsp;IDD_HTMLCONTAINERDLG,&nbsp;IDH&nbsp;=&nbsp;0&nbsp;};</span></div>这里把IDH修改为0，因为我们删除了网页资源。然而在对话框创建后会加载该资源，在CDHtmlDialog的OnInitDialog函数里面我们可以看到：<br><div style="border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; font-size: 13px; width: 98%; background-color: rgb(238, 238, 238);"><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top"><span style="color: rgb(0, 0, 0);">if&nbsp;(m_nHtmlResID)<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LoadFromResource(m_nHtmlResID);<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if&nbsp;(m_szHtmlResID)<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;LoadFromResource(m_szHtmlResID);<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;else&nbsp;if&nbsp;(m_strCurrentUrl)<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;Navigate(m_strCurrentUrl);</span></div>结果就是对话框一出现就会出现加载一个无效地址的页面，出现无法打开链接的页面，为了避免这个问题，需要重载OnInitDialog函数。其实就是拷贝mfc代码然后去掉上面那段代码就ok，强制不加载页面。那么为了加载指定页面，需要一个函数：<br><div style="border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; font-size: 13px; width: 98%; background-color: rgb(238, 238, 238);"><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top"><span style="color: rgb(0, 0, 0);">void&nbsp;CHTMLContainerDlg::SetHtmlAndCom(CString&nbsp;strURL,&nbsp;CString&nbsp;strProg)<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">{<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;HRESULT&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;hr&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;=&nbsp;NOERROR;<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;m_strURL&nbsp;=&nbsp;strURL;<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;hr&nbsp;=&nbsp;m_spComDisp.CoCreateInstance(strProg);<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;if(FAILED(hr))<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;{<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;TRACE(_T("Some&nbsp;error&nbsp;when&nbsp;create&nbsp;com&nbsp;object<img src="http://www.cppblog.com/Images/dot.gif">\n"));<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;}<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;SetExternalDispatch(m_spComDisp);<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">}</span></div>指定html的url和对应功能组件的progid，这样在网页里面可以通过脚本window.external访问该com组件。<br><b>这样就可以加载html网页，但是html页面里面的元素风格却是2k风格(至少在ie7以下版本是如此)，这个怕是没起到一点美观作用，为之我考虑了半天，问过做web的人是否有办法，最终还是灵感光临，误撞上了。重载GetHostInfo函数</b>：<br><div style="border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; font-size: 13px; width: 98%; background-color: rgb(238, 238, 238);"><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top"><span style="color: rgb(0, 0, 0);">STDMETHODIMP&nbsp;CHTMLContainerDlg::GetHostInfo(DOCHOSTUIINFO*&nbsp;pInfo)<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">{<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;pInfo-&gt;dwFlags&nbsp;=&nbsp;DOCHOSTUIFLAG_THEME;<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;return&nbsp;S_OK;<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">}</span></div>这个多得不说，^_^。<br>下面就可以演示了，在vs2005里面找个向导来show一下：<br><div style="border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; font-size: 13px; width: 98%; background-color: rgb(238, 238, 238);"><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top"><span style="color: rgb(0, 0, 0);">CHTMLContainerDlg&nbsp;&nbsp;&nbsp;&nbsp;dlg;<br><img id="Codehighlighter1_70_74_Open_Image" onclick="this.style.display='none'; Codehighlighter1_70_74_Open_Text.style.display='none'; Codehighlighter1_70_74_Closed_Image.style.display='inline'; Codehighlighter1_70_74_Closed_Text.style.display='inline';" src="http://www.cppblog.com/Images/OutliningIndicators/ExpandedBlockStart.gif" align="top"><img id="Codehighlighter1_70_74_Closed_Image" style="display: none;" onclick="this.style.display='none'; Codehighlighter1_70_74_Closed_Text.style.display='none'; Codehighlighter1_70_74_Open_Image.style.display='inline'; Codehighlighter1_70_74_Open_Text.style.display='inline';" src="http://www.cppblog.com/Images/OutliningIndicators/ContractedBlock.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;TCHAR&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;szPath[MAX_PATH]&nbsp;</span><span style="color: rgb(0, 0, 0);">=</span><span style="color: rgb(0, 0, 0);">&nbsp;</span><span id="Codehighlighter1_70_74_Closed_Text" style="border: 1px solid rgb(128, 128, 128); display: none; background-color: rgb(255, 255, 255);"><img src="http://www.cppblog.com/Images/dot.gif"></span><span id="Codehighlighter1_70_74_Open_Text"><span style="color: rgb(0, 0, 0);">{&nbsp;</span><span style="color: rgb(0, 0, 0);">0</span><span style="color: rgb(0, 0, 0);">&nbsp;}</span></span><span style="color: rgb(0, 0, 0);">;<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;CString&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;strPath;<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;GetCurrentDirectory(MAX_PATH,&nbsp;szPath);<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;strPath&nbsp;</span><span style="color: rgb(0, 0, 0);">=</span><span style="color: rgb(0, 0, 0);">&nbsp;szPath;<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;strPath&nbsp;</span><span style="color: rgb(0, 0, 0);">+=</span><span style="color: rgb(0, 0, 0);">&nbsp;_T(</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">\\Default.htm</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">);<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;dlg.SetHtmlAndCom(strPath,&nbsp;_T(</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">TestWebCom.WebComCtrl</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">));<br><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;dlg.DoModal();</span></div><br><img src="http://www.cppblog.com/images/cppblog_com/wlwlxj/730/o_dhtmldlg.JPG"><br>对话框标题其实可以通过解析html文档获取title标题设置，目前还未处理。下面看看html与应用交互的组件。<br>生成一个atl工程，TestWebCom，添加一个com组件WebComCtrl，添加方法处理上面那个带...的按钮(文件夹浏览按钮)：<br><div style="border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; font-size: 13px; width: 98%; background-color: rgb(238, 238, 238);"><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top"><span style="color: rgb(0, 0, 0);">STDMETHODIMP&nbsp;CWebComCtrl::ShowFolderBrowser(</span><span style="color: rgb(0, 0, 255);">void</span><span style="color: rgb(0, 0, 0);">)<br><img id="Codehighlighter1_50_209_Open_Image" onclick="this.style.display='none'; Codehighlighter1_50_209_Open_Text.style.display='none'; Codehighlighter1_50_209_Closed_Image.style.display='inline'; Codehighlighter1_50_209_Closed_Text.style.display='inline';" src="http://www.cppblog.com/Images/OutliningIndicators/ExpandedBlockStart.gif" align="top"><img id="Codehighlighter1_50_209_Closed_Image" style="display: none;" onclick="this.style.display='none'; Codehighlighter1_50_209_Closed_Text.style.display='none'; Codehighlighter1_50_209_Open_Image.style.display='inline'; Codehighlighter1_50_209_Open_Text.style.display='inline';" src="http://www.cppblog.com/Images/OutliningIndicators/ContractedBlock.gif" align="top"></span><span id="Codehighlighter1_50_209_Closed_Text" style="border: 1px solid rgb(128, 128, 128); display: none; background-color: rgb(255, 255, 255);"><img src="http://www.cppblog.com/Images/dot.gif"></span><span id="Codehighlighter1_50_209_Open_Text"><span style="color: rgb(0, 0, 0);">{<br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;AFX_MANAGE_STATE(AfxGetStaticModuleState());<br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top"><br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);">&nbsp;TODO:&nbsp;在此添加实现代码</span><span style="color: rgb(0, 128, 0);"><br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top"></span><span style="color: rgb(0, 0, 0);">&nbsp;&nbsp;&nbsp;&nbsp;AfxMessageBox(_T(</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">In&nbsp;Com,&nbsp;you&nbsp;can&nbsp;show&nbsp;folder&nbsp;select&nbsp;dialog</span><span style="color: rgb(0, 0, 0);">"</span><span style="color: rgb(0, 0, 0);">));<br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: rgb(0, 0, 255);">return</span><span style="color: rgb(0, 0, 0);">&nbsp;S_OK;<br><img src="http://www.cppblog.com/Images/OutliningIndicators/ExpandedBlockEnd.gif" align="top">}</span></span></div><br>这里不作具体处理，只是象征性弹出一个对话框。好了，上面我们在对话框里面已经设置了com组件的progid，这里可以把html和组件关联上了，通过脚本可以访问com组件方法：<br><div style="border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; font-size: 13px; width: 98%; background-color: rgb(238, 238, 238);"><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top"><span style="color: rgb(0, 0, 255);">&lt;</span><span style="color: rgb(128, 0, 0);">BUTTON&nbsp;</span><span style="color: rgb(255, 0, 0);">CLASS</span><span style="color: rgb(0, 0, 255);">="buttonClass3Custom"</span><span style="color: rgb(255, 0, 0);">&nbsp;ID</span><span style="color: rgb(0, 0, 255);">="BrowseBtn"</span><span style="color: rgb(255, 0, 0);">&nbsp;TYPE</span><span style="color: rgb(0, 0, 255);">="BUTTON"</span><span style="color: rgb(255, 0, 0);">&nbsp;TITLE</span><span style="color: rgb(0, 0, 255);">="浏览头文件。"</span><span style="color: rgb(255, 0, 0);">&nbsp;onClick</span><span style="color: rgb(0, 0, 255);">="OnBrowseHeaderFile();"</span><span style="color: rgb(0, 0, 255);">&gt;</span><span style="color: rgb(0, 0, 0);"><img src="http://www.cppblog.com/Images/dot.gif"></span><span style="color: rgb(0, 0, 255);">&lt;/</span><span style="color: rgb(128, 0, 0);">BUTTON</span><span style="color: rgb(0, 0, 255);">&gt;</span></div>脚本如下：<br><div style="border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; font-size: 13px; width: 98%; background-color: rgb(238, 238, 238);"><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top"><span style="color: rgb(0, 0, 255);">function</span><span style="color: rgb(0, 0, 0);">&nbsp;OnBrowseHeaderFile()<br><img id="Codehighlighter1_30_73_Open_Image" onclick="this.style.display='none'; Codehighlighter1_30_73_Open_Text.style.display='none'; Codehighlighter1_30_73_Closed_Image.style.display='inline'; Codehighlighter1_30_73_Closed_Text.style.display='inline';" src="http://www.cppblog.com/Images/OutliningIndicators/ExpandedBlockStart.gif" align="top"><img id="Codehighlighter1_30_73_Closed_Image" style="display: none;" onclick="this.style.display='none'; Codehighlighter1_30_73_Closed_Text.style.display='none'; Codehighlighter1_30_73_Open_Image.style.display='inline'; Codehighlighter1_30_73_Open_Text.style.display='inline';" src="http://www.cppblog.com/Images/OutliningIndicators/ContractedBlock.gif" align="top"></span><span id="Codehighlighter1_30_73_Closed_Text" style="border: 1px solid rgb(128, 128, 128); display: none; background-color: rgb(255, 255, 255);"><img src="http://www.cppblog.com/Images/dot.gif"></span><span id="Codehighlighter1_30_73_Open_Text"><span style="color: rgb(0, 0, 0);">{<br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top">&nbsp;&nbsp;&nbsp;<b>&nbsp;window.external.ShowFolderBrowser();</b><br><img src="http://www.cppblog.com/Images/OutliningIndicators/ExpandedBlockEnd.gif" align="top">}</span></span></div>下面运行试一试，按下选择文件夹按钮会出现如下询问组件是否安全的对话框：<br><img src="http://www.cppblog.com/images/cppblog_com/wlwlxj/730/o_dhtmldlg2.JPG"><br>这个很恼人，用户可没有耐心忍受每次多弹出这个对话框询问组件是否安全。我开始打算将组件实现安全接口解决掉此问题，不过不知道缘何，没有成功，网上搜索一下好像说在ie7里面无效，没办法还是看mfc源码来解决问题。<br>CDHtmlDialog类获取external代码如下：<br><div style="border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; font-size: 13px; width: 98%; background-color: rgb(238, 238, 238);"><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top"><span style="color: rgb(0, 0, 0);">STDMETHODIMP&nbsp;CDHtmlDialog::GetExternal(IDispatch&nbsp;</span><span style="color: rgb(0, 0, 0);">**</span><span style="color: rgb(0, 0, 0);">ppDispatch)<br><img id="Codehighlighter1_63_289_Open_Image" onclick="this.style.display='none'; Codehighlighter1_63_289_Open_Text.style.display='none'; Codehighlighter1_63_289_Closed_Image.style.display='inline'; Codehighlighter1_63_289_Closed_Text.style.display='inline';" src="http://www.cppblog.com/Images/OutliningIndicators/ExpandedBlockStart.gif" align="top"><img id="Codehighlighter1_63_289_Closed_Image" style="display: none;" onclick="this.style.display='none'; Codehighlighter1_63_289_Closed_Text.style.display='none'; Codehighlighter1_63_289_Open_Image.style.display='inline'; Codehighlighter1_63_289_Open_Text.style.display='inline';" src="http://www.cppblog.com/Images/OutliningIndicators/ContractedBlock.gif" align="top"></span><span id="Codehighlighter1_63_289_Closed_Text" style="border: 1px solid rgb(128, 128, 128); display: none; background-color: rgb(255, 255, 255);"><img src="http://www.cppblog.com/Images/dot.gif"></span><span id="Codehighlighter1_63_289_Open_Text"><span style="color: rgb(0, 0, 0);">{<br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: rgb(0, 0, 255);">if</span><span style="color: rgb(0, 0, 0);">(ppDispatch&nbsp;</span><span style="color: rgb(0, 0, 0);">==</span><span style="color: rgb(0, 0, 0);">&nbsp;NULL)<br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: rgb(0, 0, 255);">return</span><span style="color: rgb(0, 0, 0);">&nbsp;E_POINTER;<br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;<br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">ppDispatch&nbsp;</span><span style="color: rgb(0, 0, 0);">=</span><span style="color: rgb(0, 0, 0);">&nbsp;NULL;<br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: rgb(0, 0, 255);">if</span><span style="color: rgb(0, 0, 0);">&nbsp;(m_spExternalDisp.p&nbsp;</span><span style="color: rgb(0, 0, 0);">&amp;&amp;</span><span style="color: rgb(0, 0, 0);">&nbsp;CanAccessExternal())<br><img id="Codehighlighter1_182_268_Open_Image" onclick="this.style.display='none'; Codehighlighter1_182_268_Open_Text.style.display='none'; Codehighlighter1_182_268_Closed_Image.style.display='inline'; Codehighlighter1_182_268_Closed_Text.style.display='inline';" src="http://www.cppblog.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif" align="top"><img id="Codehighlighter1_182_268_Closed_Image" style="display: none;" onclick="this.style.display='none'; Codehighlighter1_182_268_Closed_Text.style.display='none'; Codehighlighter1_182_268_Open_Image.style.display='inline'; Codehighlighter1_182_268_Open_Text.style.display='inline';" src="http://www.cppblog.com/Images/OutliningIndicators/ContractedSubBlock.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="Codehighlighter1_182_268_Closed_Text" style="border: 1px solid rgb(128, 128, 128); display: none; background-color: rgb(255, 255, 255);"><img src="http://www.cppblog.com/Images/dot.gif"></span><span id="Codehighlighter1_182_268_Open_Text"><span style="color: rgb(0, 0, 0);">{<br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;m_spExternalDisp.p</span><span style="color: rgb(0, 0, 0);">-&gt;</span><span style="color: rgb(0, 0, 0);">AddRef();<br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: rgb(0, 0, 0);">*</span><span style="color: rgb(0, 0, 0);">ppDispatch&nbsp;</span><span style="color: rgb(0, 0, 0);">=</span><span style="color: rgb(0, 0, 0);">&nbsp;m_spExternalDisp.p;<br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: rgb(0, 0, 255);">return</span><span style="color: rgb(0, 0, 0);">&nbsp;S_OK;<br><img src="http://www.cppblog.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;}</span></span><span style="color: rgb(0, 0, 0);"><br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: rgb(0, 0, 255);">return</span><span style="color: rgb(0, 0, 0);">&nbsp;E_NOTIMPL;<br><img src="http://www.cppblog.com/Images/OutliningIndicators/ExpandedBlockEnd.gif" align="top">}</span></span></div><b>看到CanAccessExternal函数，肯定就是验证安全性的代码，找到函数声明，幸好是虚函数，重载直接返回TRUE：</b><br><div style="border: 1px solid rgb(204, 204, 204); padding: 4px 5px 4px 4px; font-size: 13px; width: 98%; background-color: rgb(238, 238, 238);"><img src="http://www.cppblog.com/Images/OutliningIndicators/None.gif" align="top"><span style="color: rgb(0, 0, 0);">BOOL&nbsp;CHTMLContainerDlg::CanAccessExternal()<br><img id="Codehighlighter1_44_115_Open_Image" onclick="this.style.display='none'; Codehighlighter1_44_115_Open_Text.style.display='none'; Codehighlighter1_44_115_Closed_Image.style.display='inline'; Codehighlighter1_44_115_Closed_Text.style.display='inline';" src="http://www.cppblog.com/Images/OutliningIndicators/ExpandedBlockStart.gif" align="top"><img id="Codehighlighter1_44_115_Closed_Image" style="display: none;" onclick="this.style.display='none'; Codehighlighter1_44_115_Closed_Text.style.display='none'; Codehighlighter1_44_115_Open_Image.style.display='inline'; Codehighlighter1_44_115_Open_Text.style.display='inline';" src="http://www.cppblog.com/Images/OutliningIndicators/ContractedBlock.gif" align="top"></span><span id="Codehighlighter1_44_115_Closed_Text" style="border: 1px solid rgb(128, 128, 128); display: none; background-color: rgb(255, 255, 255);"><img src="http://www.cppblog.com/Images/dot.gif"></span><span id="Codehighlighter1_44_115_Open_Text"><span style="color: rgb(0, 0, 0);">{<br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: rgb(0, 128, 0);">//</span><span style="color: rgb(0, 128, 0);">&nbsp;we&nbsp;trust&nbsp;all&nbsp;com&nbsp;object&nbsp;(haha,&nbsp;you&nbsp;can&nbsp;make&nbsp;virus)</span><span style="color: rgb(0, 128, 0);"><br><img src="http://www.cppblog.com/Images/OutliningIndicators/InBlock.gif" align="top"></span><span style="color: rgb(0, 0, 0);">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: rgb(0, 0, 255);">return</span><span style="color: rgb(0, 0, 0);">&nbsp;TRUE;<br><img src="http://www.cppblog.com/Images/OutliningIndicators/ExpandedBlockEnd.gif" align="top">}</span></span></div>有兴趣的朋友可以看下内部实现。<br>这下就好了，按下网页选择文件夹按钮，弹出对话框：<br><img src="http://www.cppblog.com/images/cppblog_com/wlwlxj/730/o_dhtmldlg3.JPG"><br>一套流程完备，方案个人觉得不错，各司其职，通信自然畅通，一个html配对一个com功能组件，功能组件化不仅使代码封装性好，而且可以用于多种语言。<br><br>由于此技术不用于公司开发，今整理提供<a href="http://www.cppblog.com/files/wlwlxj/WebGUI.rar">下载</a>
	<div class="postDesc">posted on 2006-12-15 21:11 <a href="http://www.cppblog.com/wlwlxj/">万连文</a> 阅读(5006) <a href="http://www.cppblog.com/wlwlxj/archive/2006/12/15/16495.html#Post">评论(25)</a> &nbsp;<a href="http://www.cppblog.com/wlwlxj/admin/EditPosts.aspx?postid=16495">编辑</a>&nbsp;<a href="http://www.cppblog.com/wlwlxj/AddToFavorite.aspx?id=16495">收藏</a> <a href="http://www.cppblog.com/wlwlxj/services/trackbacks/16495.aspx">引用</a>  所属分类: <a href="http://www.cppblog.com/wlwlxj/category/2266.html">MFC</a> </div>
</div>