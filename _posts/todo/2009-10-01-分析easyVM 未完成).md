---
categories: todo
---
E:\test\easyVM_Small_<br />指令解析,cpu虚拟<br />设备虚拟,比如display, DMA, floppy, harddisk, keyboard, PIC, printer, RTC, timer,serial<br />程序flow, 架构<br /><br />低调发布easyVM 0.2版<br /><br />简介：<br />＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝<br />easyVM是一个简单的虚拟机。<br />0.1版本只支持8086指令集和一些简单的I/O设备，只支持英文文本显示方式。<br />0.2版本主要是在0.1版基础上加了一小部分32位指令（push eax等），使得easyVM可以运行MS-DOS 6.22自带的大部分程序。<br /><br />文件说明：<br />＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝＝<br />Bios\Bios.bin&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; Bios程序<br />Bios\BiosData.bin&nbsp;&nbsp;&nbsp; CMOS数据区<br />DOS.IMG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; MS-DOS 6.22的镜像<br />easyVM.exe&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; easyVM主程序<br />easyVM.ini&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; easyVM的配置文件<br />Readme.txt&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 本说明文本<br />TC.IMG&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 含有Trubo C 2.0的软盘镜像<br />Dos622c.img&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp; 硬盘镜像<br /><br />easyVM.ini配置文件<br />[Memory]<br />;MB<br />Size=32<br /><br />[IMG]<br />A=DOS.IMG<br />B=TC.IMG<br />C=<br />cylinders=20<br />heads=16<br />spt=63<br /><br />[Boot]<br />Boot=A<br /><br />程序流程:<br />WinMain<br />&nbsp;&nbsp; &nbsp;VMInit<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;CPUInit<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;设置cpu从eCPU.cs=0xf000;eCPU.ip=0xfff0;开始执行<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;初始化InTable,和outTable<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;malloc memory for MemoryStart<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read BIOS\\BiosData.bin to MemoryStart+0x400, size=0x100<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;set boot drive<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;*(char *)(MemoryStart+0x0400+0x0100)=0 for A<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;*(char *)(MemoryStart+0x0400+0x0100)=1 for B<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;read BIOS\\BIOS.bin to MemoryStart+0xf0000, size=<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;DispInit<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;PICInit();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;RTCInit();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;FloppyInit();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;HardDiskInit();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;DMAInit();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;PrinterInit();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SerialInit();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;KeyBoardInit();<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;SystemTimerInit();<br />&nbsp;&nbsp; &nbsp;VMRun<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;CPURun:里面用一个for不断执行<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ExecIns<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;根据当前ip:evIP得到内存中当前指令OpC<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;从InsTable[Opc]得到指令对应的函数的地址<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;执行该函数<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;RefreshVideoRAM<br /><br />&nbsp;&nbsp; &nbsp;VMShutDown<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;CPUTerminate<br /><br />cpu虚拟主要文件为cpu/cpu.cpp, cpu/instructions.cpp<br />struct CPU 定义了cpu的所有寄存器<br />SetupInstructionTable用于设置InsTable, <br /><br />消息响应,比如键盘,WM_PAINT等,在WndProc函数中(IO\Display.cpp)定义<br /><br />对于显示模块, 用了一条IO指令来代替整个INT 10H(out&nbsp;&nbsp; &nbsp;0b0h,al. 在easyvmBIOS.asm说明),INT10H的具体程序在Display.cpp里实现, <br />函数IO_Write_00B0<br />&nbsp;&nbsp; &nbsp;<br /><br />OnPaint<br />&nbsp;&nbsp; &nbsp;TextBufOut<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;根据不同字符属性,将显存缓冲分成多个子字符串,分别显示<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;画光标<br />