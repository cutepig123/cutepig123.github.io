<div><h1><a name="LARTC.RPDB.MULTIPLE-LINKS">http://lartc.org/howto/lartc.rpdb.multiple-links.html</a></h1><p>4.2. Routing for multiple uplinks/providers</p><p><a name="LARTC.RPDB.MULTIPLE-LINKS">A common configuration is the following, in which there are two providers that connect a local network (or even a single machine) to the big Internet.  </a></p><pre><a name="LARTC.RPDB.MULTIPLE-LINKS">                                                                 ________<br />                                          +------------+        /<br />                                          |            |       |<br />                            +-------------+ Provider 1 +-------<br />        __                  |             |            |     /<br />    ___/  \_         +------+-------+     +------------+    |<br />  _/        \__      |     if1      |                      /<br /> /             \     |              |                      |<br />| Local network -----+ Linux router |                      |     Internet<br /> \_           __/    |              |                      |<br />   \__     __/       |     if2      |                      \<br />      \___/          +------+-------+     +------------+    |<br />                            |             |            |     \<br />                            +-------------+ Provider 2 +-------<br />                                          |            |       |<br />                                          +------------+        \________</a></pre><p><a name="LARTC.RPDB.MULTIPLE-LINKS">There are usually two questions given this setup.</a></p><div><h2><a name="AEN268">4.2.1. Split access</a></h2><p><a name="AEN268">	  The first is how to route answers to packets coming in over a 	  particular provider, say Provider 1, back out again over that same provider. 	</a></p><p><a name="AEN268">	  Let us first set some symbolical names. Let <strong>$IF1</strong> be the name of the 	  first interface (if1 in the picture above) and <strong>$IF2</strong> the name of the 	  second interface. Then let <strong>$IP1</strong> be the IP address associated with 	  <strong>$IF1</strong> and <strong>$IP2</strong> the IP address associated with 	  <strong>$IF2</strong>. Next, let <strong>$P1</strong> be the IP address of the gateway at 	  Provider 1, and <strong>$P2</strong> the IP address of the gateway at provider 2. 	  Finally, let <strong>$P1_NET</strong> be the IP network <strong>$P1</strong> is in, 	  and <strong>$P2_NET</strong> the IP network <strong>$P2</strong> is in. 	</a></p><p><a name="AEN268">	  One creates two additional routing tables, say <strong>T1</strong> and <strong>T2</strong>. 	  These are added in /etc/iproute2/rt_tables. Then you set up routing in 	  these tables as follows: 	</a></p><p><a name="AEN268">	</a></p><pre><a name="AEN268">	  ip route add $P1_NET dev $IF1 src $IP1 table T1<br />	  ip route add default via $P1 table T1<br />	  ip route add $P2_NET dev $IF2 src $IP2 table T2<br />	  ip route add default via $P2 table T2<br />	</a></pre> <a name="AEN268">	   	  Nothing spectacular, just build a route to the gateway and build a 	  default route via that gateway, as you would do in the case of a single 	  upstream provider, but put the routes in a separate table per provider. 	  Note that the network route suffices, as it tells you how to find any host 	  in that network, which includes the gateway, as specified above. 	</a><p><a name="AEN268">	  Next you set up the main routing table. It is a good idea to route 	  things to the direct neighbour through the interface connected to that 	  neighbour. Note the `src' arguments, they make sure the right outgoing IP 	  address is chosen.  	  </a></p><pre><a name="AEN268">	    ip route add $P1_NET dev $IF1 src $IP1<br />	    ip route add $P2_NET dev $IF2 src $IP2<br />	  </a></pre>  <a name="AEN268">	  Then, your preference for default route: 	   	  </a><pre><a name="AEN268">	    ip route add default via $P1<br />	  </a></pre>  <a name="AEN268">	  Next, you set up the routing rules. These actually choose what routing table 	  to route with. You want to make sure that you route out a given 	  interface if you already have the corresponding source address: 	   	  </a><pre><a name="AEN268">	    ip rule add from $IP1 table T1<br />	    ip rule add from $IP2 table T2<br />	  </a></pre>  <a name="AEN268">	  This set of commands makes sure all answers to traffic coming in on a 	  particular interface get answered from that interface. 	</a><p><a name="AEN268">	</a></p><div><table border="0" width="100%"><tbody><tr><td align="center" valign="top" width="25"><img src="http://lartc.org/docbook-dsssl/warning.gif" alt="Warning" hspace="5" /></td><td align="left" valign="top"><p>Reader Rod Roark notes: 'If $P0_NET is the local network and $IF0 is its interface, the following additional entries are desirable: </p><pre>ip route add $P0_NET     dev $IF0 table T1<br />ip route add $P2_NET     dev $IF2 table T1<br />ip route add 127.0.0.0/8 dev lo   table T1<br />ip route add $P0_NET     dev $IF0 table T2<br />ip route add $P1_NET     dev $IF1 table T2<br />ip route add 127.0.0.0/8 dev lo   table T2                                      </pre>'</td></tr></tbody></table></div><p><a name="AEN268">	  Now, this is just the very basic setup. It will work for all processes 	  running on the router itself, and for the local network, if it is 	  masqueraded. If it is not, then you either have IP space from both providers 	  or you are going to want to masquerade to one of the two providers. In both 	  cases you will want to add rules selecting which provider to route out from 	  based on the IP address of the machine in the local network.  	</a></p></div><div><h2><a name="AEN298">4.2.2. Load balancing</a></h2><p><a name="AEN298">	  The second question is how to balance traffic going out over the two providers. 	  This is actually not hard if you already have set up split access as above. 	  </a></p><p><a name="AEN298">	  Instead of choosing one of the two providers as your default route, 	  you now set up the default route to be a multipath route. In the default 	  kernel this will balance routes over the two providers. It is done 	  as follows (once more building on the example in the section on 	  split-access):  	  </a></p><pre><a name="AEN298">	    ip route add default scope global nexthop via $P1 dev $IF1 weight 1 \<br />	    nexthop via $P2 dev $IF2 weight 1<br />	  </a></pre>  <a name="AEN298">	  This will balance the routes over both providers. The <strong>weight</strong> 	  parameters can be tweaked to favor one provider over the other. 	</a><p><a name="AEN298">	  Note that balancing will not be perfect, as it is route based, and routes 	  are cached. This means that routes to often-used sites will always 	  be over the same provider. 	</a></p><p><a name="AEN298">	  Furthermore, if you really want to do this, you probably also want to look 	  at Julian Anastasov's patches at </a><a href="http://www.ssi.bg/%7Eja/#routes" target="_blank">http://www.ssi.bg/~ja/#routes  	    </a>, Julian's route patch page. They will make things nicer to work with. 	</p></div></div><hr align="left" width="100%" />