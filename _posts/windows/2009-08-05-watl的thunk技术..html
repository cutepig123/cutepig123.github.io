用dialog为例<br />CAboutDlg dlg;<br />dlg.DoModal();<br />其中class CAboutDlg : public CDialogImpl&lt;CAboutDlg&gt;{...}<br />当执行到dlg.DoModal();里面的<br />return ::DialogBoxParam(_AtlBaseModule.GetResourceInstance(), MAKEINTRESOURCE(static_cast&lt;T*&gt;(this)-&gt;IDD),<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;hWndParent, T::StartDialogProc, dwInitParam);<br />时, 会调用StartDialogProc函数<br />该函数如下<br /><div class="cnblogs_code"><!--<br /><br />Code highlighting produced by Actipro CodeHighlighter (freeware)<br />http://www.CodeHighlighter.com/<br /><br />--><span style="color: #008080;">&nbsp;1</span><img src="http://www.cnblogs.com/Images/OutliningIndicators/None.gif" alt="" align="top" /><span style="color: #000000;">template&nbsp;</span><span style="color: #000000;">&lt;</span><span style="color: #0000ff;">class</span><span style="color: #000000;">&nbsp;TBase</span><span style="color: #000000;">&gt;</span><span style="color: #000000;"><br /></span><span style="color: #008080;">&nbsp;2</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/None.gif" alt="" align="top" />INT_PTR&nbsp;CALLBACK&nbsp;CDialogImplBaseT</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">&nbsp;TBase&nbsp;</span><span style="color: #000000;">&gt;</span><span style="color: #000000;">::StartDialogProc(HWND&nbsp;hWnd,&nbsp;UINT&nbsp;uMsg,&nbsp;WPARAM&nbsp;wParam,&nbsp;LPARAM&nbsp;lParam)<br /></span><span style="color: #008080;">&nbsp;3</span><span style="color: #000000;"><img id="Codehighlighter1_135_941_Open_Image" src="http://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockStart.gif" onclick="this.style.display='none'; document.getElementById('Codehighlighter1_135_941_Open_Text').style.display='none'; document.getElementById('Codehighlighter1_135_941_Closed_Image').style.display='inline'; document.getElementById('Codehighlighter1_135_941_Closed_Text').style.display='inline';" align="top"><img id="Codehighlighter1_135_941_Closed_Image" src="http://www.cnblogs.com/Images/OutliningIndicators/ContractedBlock.gif" style="display: none;" onclick="this.style.display='none'; document.getElementById('Codehighlighter1_135_941_Closed_Text').style.display='none'; document.getElementById('Codehighlighter1_135_941_Open_Image').style.display='inline'; document.getElementById('Codehighlighter1_135_941_Open_Text').style.display='inline';" align="top"></span><span id="Codehighlighter1_135_941_Closed_Text" style="border: 1px solid #808080; background-color: #ffffff; display: none;"><img src="http://www.cnblogs.com/Images/dot.gif" alt="" /></span><span id="Codehighlighter1_135_941_Open_Text"><span style="color: #000000;">{<br /></span><span style="color: #008080;">&nbsp;4</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" />&nbsp;&nbsp;&nbsp;&nbsp;CDialogImplBaseT</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">&nbsp;TBase&nbsp;</span><span style="color: #000000;">&gt;*</span><span style="color: #000000;">&nbsp;pThis&nbsp;</span><span style="color: #000000;">=</span><span style="color: #000000;">&nbsp;(CDialogImplBaseT</span><span style="color: #000000;">&lt;</span><span style="color: #000000;">&nbsp;TBase&nbsp;</span><span style="color: #000000;">&gt;*</span><span style="color: #000000;">)_AtlWinModule.ExtractCreateWndData();<br /></span><span style="color: #008080;">&nbsp;5</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" />&nbsp;&nbsp;&nbsp;&nbsp;ATLASSERT(pThis&nbsp;</span><span style="color: #000000;">!=</span><span style="color: #000000;">&nbsp;NULL);<br /></span><span style="color: #008080;">&nbsp;6</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">(</span><span style="color: #000000;">!</span><span style="color: #000000;">pThis)<br /></span><span style="color: #008080;">&nbsp;7</span><span style="color: #000000;"><img id="Codehighlighter1_279_295_Open_Image" src="http://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockStart.gif" onclick="this.style.display='none'; document.getElementById('Codehighlighter1_279_295_Open_Text').style.display='none'; document.getElementById('Codehighlighter1_279_295_Closed_Image').style.display='inline'; document.getElementById('Codehighlighter1_279_295_Closed_Text').style.display='inline';" align="top"><img id="Codehighlighter1_279_295_Closed_Image" src="http://www.cnblogs.com/Images/OutliningIndicators/ContractedSubBlock.gif" style="display: none;" onclick="this.style.display='none'; document.getElementById('Codehighlighter1_279_295_Closed_Text').style.display='none'; document.getElementById('Codehighlighter1_279_295_Open_Image').style.display='inline'; document.getElementById('Codehighlighter1_279_295_Open_Text').style.display='inline';" align="top">&nbsp;&nbsp;&nbsp;&nbsp;</span><span id="Codehighlighter1_279_295_Closed_Text" style="border: 1px solid #808080; background-color: #ffffff; display: none;"><img src="http://www.cnblogs.com/Images/dot.gif" alt="" /></span><span id="Codehighlighter1_279_295_Open_Text"><span style="color: #000000;">{<br /></span><span style="color: #008080;">&nbsp;8</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&nbsp;</span><span style="color: #800080;">0</span><span style="color: #000000;">;<br /></span><span style="color: #008080;">&nbsp;9</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/ExpandedSubBlockEnd.gif" alt="" align="top" />&nbsp;&nbsp;&nbsp;&nbsp;}</span></span><span style="color: #000000;"><br /></span><span style="color: #008080;">10</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" />&nbsp;&nbsp;&nbsp;&nbsp;pThis</span><span style="color: #000000;">-&gt;</span><span style="color: #000000;">m_hWnd&nbsp;</span><span style="color: #000000;">=</span><span style="color: #000000;">&nbsp;hWnd;<br /></span><span style="color: #008080;">11</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000;">//</span><span style="color: #008000;">&nbsp;Initialize&nbsp;the&nbsp;thunk.&nbsp;&nbsp;This&nbsp;was&nbsp;allocated&nbsp;in&nbsp;CDialogImpl::DoModal&nbsp;or<br /></span><span style="color: #008080;">12</span><span style="color: #008000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000;">//</span><span style="color: #008000;">&nbsp;CDialogImpl::Create,&nbsp;so&nbsp;failure&nbsp;is&nbsp;unexpected&nbsp;here.</span><span style="color: #008000;"><br /></span><span style="color: #008080;">13</span><span style="color: #008000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" /></span><span style="color: #000000;"><br /></span><span style="color: #008080;">14</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" />&nbsp;&nbsp;&nbsp;&nbsp;pThis</span><span style="color: #000000;">-&gt;</span><span style="color: #000000;">m_thunk.Init((WNDPROC)pThis</span><span style="color: #000000;">-&gt;</span><span style="color: #000000;">GetDialogProc(),&nbsp;pThis);<br /></span><span style="color: #008080;">15</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" />&nbsp;&nbsp;&nbsp;&nbsp;DLGPROC&nbsp;pProc&nbsp;</span><span style="color: #000000;">=</span><span style="color: #000000;">&nbsp;(DLGPROC)pThis</span><span style="color: #000000;">-&gt;</span><span style="color: #000000;">m_thunk.GetWNDPROC();<br /></span><span style="color: #008080;">16</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" />&nbsp;&nbsp;&nbsp;&nbsp;DLGPROC&nbsp;pOldProc&nbsp;</span><span style="color: #000000;">=</span><span style="color: #000000;">&nbsp;(DLGPROC)::SetWindowLongPtr(hWnd,&nbsp;DWLP_DLGPROC,&nbsp;(LONG_PTR)pProc);<br /></span><span style="color: #008080;">17</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" />#ifdef&nbsp;_DEBUG<br /></span><span style="color: #008080;">18</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000;">//</span><span style="color: #008000;">&nbsp;check&nbsp;if&nbsp;somebody&nbsp;has&nbsp;subclassed&nbsp;us&nbsp;already&nbsp;since&nbsp;we&nbsp;discard&nbsp;it</span><span style="color: #008000;"><br /></span><span style="color: #008080;">19</span><span style="color: #008000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" /></span><span style="color: #000000;">&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000ff;">if</span><span style="color: #000000;">(pOldProc&nbsp;</span><span style="color: #000000;">!=</span><span style="color: #000000;">&nbsp;StartDialogProc)<br /></span><span style="color: #008080;">20</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" />&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;ATLTRACE(atlTraceWindowing,&nbsp;</span><span style="color: #800080;">0</span><span style="color: #000000;">,&nbsp;_T(</span><span style="color: #800000;">"</span><span style="color: #800000;">Subclassing&nbsp;through&nbsp;a&nbsp;hook&nbsp;discarded.\n</span><span style="color: #800000;">"</span><span style="color: #000000;">));<br /></span><span style="color: #008080;">21</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" /></span><span style="color: #0000ff;">#else</span><span style="color: #000000;"><br /></span><span style="color: #008080;">22</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" />&nbsp;&nbsp;&nbsp;&nbsp;pOldProc;&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #008000;">//</span><span style="color: #008000;">&nbsp;avoid&nbsp;unused&nbsp;warning</span><span style="color: #008000;"><br /></span><span style="color: #008080;">23</span><span style="color: #008000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" /></span><span style="color: #0000ff;">#endif</span><span style="color: #000000;"><br /></span><span style="color: #008080;">24</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/InBlock.gif" alt="" align="top" />&nbsp;&nbsp;&nbsp;&nbsp;</span><span style="color: #0000ff;">return</span><span style="color: #000000;">&nbsp;pProc(hWnd,&nbsp;uMsg,&nbsp;wParam,&nbsp;lParam);<br /></span><span style="color: #008080;">25</span><span style="color: #000000;"><img src="http://www.cnblogs.com/Images/OutliningIndicators/ExpandedBlockEnd.gif" alt="" align="top" />}</span></span></div>第11行初始化thunk, 该thunk会alloc内存,然后向该内存写入 mov hWnd, pthis; jmp wndProc这里的wndProc为成员函数 template &lt;class TBase&gt;<br />INT_PTR CALLBACK CDialogImplBaseT&lt; TBase &gt;::DialogProc(HWND hWnd, UINT uMsg, WPARAM wParam, LPARAM lParam)<br />{<br />CDialogImplBaseT&lt; TBase &gt;* pThis = (CDialogImplBaseT&lt; TBase &gt;*)hWnd;<br />...<br />看到该函数第一行直接将hWnd转换为类指针了吧, 其实这个hWnd是假的, 真正保存的的确是类指针, 该替换是在thunk里面做的<br />具体调用顺序为:<br />我们设置好wndProc (其实是这个thunk)<br />该窗口有消息来时,调用wndproc, 这里会对hWnd做一个替换,然后真正调用成员函数DialogProc<br />...over....<br />有时间仿照这个写一个简单的, 示范一下