<p>入口函数load_module<br />&nbsp;&nbsp; &nbsp;load_config<br />&nbsp;&nbsp; &nbsp;ast_channel_register console_tech<br />&nbsp;&nbsp; &nbsp;ast_cli_register_multiple<br />&nbsp;&nbsp; &nbsp;<br />console_tech需要提供一系列的毁掉函数，比如&nbsp;&nbsp; &nbsp;<br />&nbsp;&nbsp; &nbsp;static struct ast_channel_tech console_tech = {<br />&nbsp;&nbsp; &nbsp;.type = "Console",<br />&nbsp;&nbsp; &nbsp;.description = "Console Channel Driver",<br />&nbsp;&nbsp; &nbsp;.requester = console_request,<br />&nbsp;&nbsp; &nbsp;.send_digit_begin = console_digit_begin,<br />&nbsp;&nbsp; &nbsp;.send_digit_end = console_digit_end,<br />&nbsp;&nbsp; &nbsp;.send_text = console_text,<br />&nbsp;&nbsp; &nbsp;.hangup = console_hangup,<br />&nbsp;&nbsp; &nbsp;.answer = console_answer,<br />&nbsp;&nbsp; &nbsp;.read = console_read,<br />&nbsp;&nbsp; &nbsp;.call = console_call,<br />&nbsp;&nbsp; &nbsp;.write = console_write,<br />&nbsp;&nbsp; &nbsp;.indicate = console_indicate,<br />&nbsp;&nbsp; &nbsp;.fixup = console_fixup,<br />&nbsp;&nbsp; &nbsp;};<br /><br />answer一般会启动monitor thread</p>
<p>&nbsp;</p>
<p>sample: chan_console.c</p>
<p>&nbsp;</p>
<p>http://svn.asterisk.org/svn/asterisk/trunk/channels/chan_oss.c</p>
<p>https://code.google.com/p/asterisk-chan-dongle/</p>
<p>&nbsp;</p>
<p>讨论</p>
<p>http://lists.digium.com/pipermail/asterisk-dev/2008-January/031719.html</p>
<p>&nbsp;</p>
<p>&nbsp;</p>
<p>load_module<br />&nbsp;&nbsp; &nbsp;ast_calloc gpublic<br />&nbsp;&nbsp; &nbsp;pdiscovery_init<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cache_init<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;AST_RWLIST_HEAD_INIT<br />&nbsp;&nbsp; &nbsp;public_state_init<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;reload_config<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;discovery_restart<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ast_pthread_create_background（ do_discovery ）<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;the thread loops all devices<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;看看要做啥就做啥，比如<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;打开设备opentty<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;start_monitor monitor_thread do_monitor_phone<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;该线程监视data_fd和audio_fd<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;port_status<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;tcgetattr<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;at_wait<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;at_read<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;PVT_STAT<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;at_read_result_iov<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;at_read_result_classification<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;at_response<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;移除设备AST_RWLIST_REMOVE_CURRENT， pvt_free<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ast_channel_register(&amp;channel_tech)<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;cli_register<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;app_register<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;manager_register<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;discovery_stop<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;devices_destroy<br />&nbsp;&nbsp; &nbsp;<br />public_state<br />&nbsp;&nbsp; &nbsp;devices<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;a list<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;AST_RWLIST_HEAD_INIT<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;AST_RWLIST_RDLOCK<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;AST_RWLIST_TRAVERSE<br />&nbsp;&nbsp; &nbsp;discovery_lock<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;a mutex<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ast_mutex_init<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ast_mutex_lock<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;ast_mutex_destroy<br />&nbsp;&nbsp; &nbsp;discovery_thread<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;a thread<br />&nbsp;&nbsp; &nbsp;&nbsp;&nbsp; &nbsp;?</p>
<p>&nbsp;</p>